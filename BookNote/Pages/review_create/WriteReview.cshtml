@page
@model WriteReviewModel
@{
    bool isPublished = Model.IsPublished;
    ViewData["Title"] = isPublished ? "レビューを編集" : "レビューを書く";
}

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookNote - @ViewData["Title"]</title>
    <link type="text/css" rel="stylesheet" href="~/css/site.css">
    <link type="text/css" rel="stylesheet" href="~/css/write-review.css">

    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<partial name="_BookSearchDialog" />
<body class="write-review-page">
    <!-- メインコンテンツ -->
    <div class="main-content">
        <h1 class="page-title">@(isPublished ? "レビューを編集" : "レビューを書く")</h1>

        @if (isPublished) {
            <div class="alert-message edit-mode-notice">
                <svg class="notice-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                編集モード：レビュー本文とネタバレ設定のみ変更できます
            </div>
        }

        @if (TempData["Error"] != null) {
            <div class="alert-message error-message">
                @TempData["Error"]
            </div>
        }
        @if (TempData["Message"] != null) {
            <div class="alert-message">@TempData["Message"]</div>
        }

        <form id="review-form" class="review-form" method="post">
            <!-- 書籍情報セクション -->
            <div class="form-section">
                <label class="form-label">書籍情報<span class="required">*</span></label>
                @if (!isPublished) {
                    <div class="book-search-container">
                        <button type="button" class="search-small-button" id="book-search-button">書籍を検索</button>
                    </div>
                }
                <div id="selected-book" class="selected-book" style="display: @(string.IsNullOrEmpty(Model.ReviewInput?.BookIsbn) || Model.ReviewInput?.BookIsbn == "0000000000000" ? "none" : "flex");">
                    <div class="book-cover-small">
                        <img id="selected-book-image" src="" alt="" style="display: none;">
                        <span id="selected-book-noimage">NoImage</span>
                    </div>
                    <div class="book-info">
                        <div class="book-title-display">@Model.ReviewInput?.BookTitle</div>
                        <div class="book-author">@Model.ReviewInput?.BookAuthor</div>
                    </div>
                    @if (!isPublished) {
                        <button type="button" class="remove-button" onclick="removeBook()">×</button>
                    }
                </div>
                <input type="hidden" asp-for="ReviewId" />
                <input type="hidden" asp-for="ReviewInput.BookIsbn" id="hidden-book-isbn">
                <input type="hidden" asp-for="ReviewInput.BookTitle" id="hidden-book-title">
                <input type="hidden" asp-for="ReviewInput.BookAuthor" id="hidden-book-author">
                <input type="hidden" asp-for="ReviewInput.BookPublisher" id="hidden-book-publisher">
                <span asp-validation-for="ReviewInput.BookTitle" class="text-danger"></span>
            </div>

            <!-- レビュータイトル -->
            <div class="form-section">
                <label class="form-label" asp-for="ReviewInput.Title">
                    レビュータイトル (20文字以内)<span class="required">*</span>
                </label>
                <input type="text" class="form-input" asp-for="ReviewInput.Title"
                       placeholder="例: 心に響く物語"
                       disabled="@isPublished" readonly="@isPublished">
                <span asp-validation-for="ReviewInput.Title" class="text-danger"></span>
            </div>

            <!-- 評価 -->
            <div class="form-section">
                <label class="form-label">評価<span class="required">*</span></label>
                <div class="rating-container @(isPublished ? "disabled-section" : "")">
                    <span class="star @(isPublished ? "disabled" : "")" data-rating="1">☆</span>
                    <span class="star @(isPublished ? "disabled" : "")" data-rating="2">☆</span>
                    <span class="star @(isPublished ? "disabled" : "")" data-rating="3">☆</span>
                    <span class="star @(isPublished ? "disabled" : "")" data-rating="4">☆</span>
                    <span class="star @(isPublished ? "disabled" : "")" data-rating="5">☆</span>
                </div>
                <input type="hidden" asp-for="ReviewInput.Rating" id="rating-value">
                <span asp-validation-for="ReviewInput.Rating" class="text-danger"></span>
            </div>

            <!-- ネタバレ選択 -->
            <div class="form-section">
                <label class="form-label">ネタバレの有無</label>
                <label class="spoiler-checkbox">
                    <input type="checkbox" asp-for="ReviewInput.ContainsSpoiler">
                    ネタバレあり
                </label>
            </div>

            <!-- レビュー本文 -->
            <div class="form-section">
                <label class="form-label">レビュー本文<span class="required">*</span></label>
                <div id="editor-container"></div>
                <textarea asp-for="ReviewInput.ContentHtml" id="review-content-html" style="display: none;"></textarea>
                <span asp-validation-for="ReviewInput.ContentHtml" class="text-danger"></span>
            </div>

            <!-- ボタン群 -->
            <div class="form-actions">
                @if (isPublished) {
                    <a href="/ReviewDetails/@Model.ReviewId" class="btn-secondary btn-link-back">キャンセル</a>
                    <button type="submit" class="btn-primary" asp-page-handler="Publish" onclick="return prepareFormSubmit(false)">変更を保存</button>
                } else {
                    <button type="submit" class="btn-secondary" asp-page-handler="SaveDraft" onclick="return prepareFormSubmit(true)">下書き保存</button>
                    <button type="submit" class="btn-primary" asp-page-handler="Publish" onclick="return prepareFormSubmit(false)">投稿する</button>
                }
            </div>
        </form>

        <!-- プレビューエリア（オプション） -->
        <div class="preview-section" style="display: none;">
            <h2 class="preview-title">プレビュー</h2>
            <div id="preview-content"></div>
        </div>
    </div>

    <script>
        // 既存レビューデータがあれば初期設定
        window.existingReview = {
            bookIsbn: '@Html.Raw(Model.ReviewInput.BookIsbn)',
            bookTitle: '@Html.Raw(Model.ReviewInput.BookTitle)',
            bookAuthor: '@Html.Raw(Model.ReviewInput.BookAuthor)',
            rating: @Model.ReviewInput.Rating,
            contentHtml: @Html.Raw(Json.Serialize(Model.ReviewInput.ContentHtml))
        };
        window.isPublished = @Json.Serialize(isPublished);
    </script>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="text/javascript" src="~/js/site.js"></script>
    <script type="text/javascript" src="~/js/write-review.js"></script>
</body>
</html>